<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>SSE Chat</title>
</head>

<body>

<h1>SSE ì‹¤ì‹œê°„ ì±„íŒ…</h1>
<hr>

<div>
    <input id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<ul id="chat-box" style="margin-top: 20px;"></ul>

<script>
    // ğŸ”¥ 1. SSE ìŠ¤íŠ¸ë¦¼ ì—°ê²° (ìŠ¤í¬ë¦½íŠ¸ê°€ body ëì— ìˆì–´ DOMContentLoaded ì—†ì´ ë°”ë¡œ ì‹¤í–‰)
    const sse = new EventSource("/chats/connect");

    // ìµœì´ˆ ì—°ê²°ì‹œ ë”ë¯¸(connect) ì´ë²¤íŠ¸
    sse.addEventListener("connect", (e) => {
        console.log("connected:", e.data); // "connected"
    });

    // ì„œë²„ê°€ push í•˜ëŠ” chat ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    sse.addEventListener("chat", (e) => {
        console.log("chat event:", e.data);
        const chat = JSON.parse(e.data);
        appendChat(chat.message);
    });

    // ğŸ”¥ 2. ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
        const messageInput = document.getElementById("message");
        const message = messageInput.value.trim();

        await fetch("/chats", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        });

        messageInput.value = "";
        messageInput.focus();
    }

    // ğŸ”¥ 3. í™”ë©´ ì±„íŒ… DOM ì—…ë°ì´íŠ¸
    function appendChat(message) {
        const box = document.getElementById("chat-box");
        const li = document.createElement("li");
        li.innerText = message;
        box.prepend(li);
    }
</script>

</body>
</html>
